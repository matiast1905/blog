[
  {
    "objectID": "posts/global-mortality-analysis/Analysis.html",
    "href": "posts/global-mortality-analysis/Analysis.html",
    "title": "Global Mortality Analysis",
    "section": "",
    "text": "In this blog post I will analyze the causes of death dataset from our world in data. A copy of the dataset is uploaded in this link of the blog’s github\nLet’s start by loading in the data\n\nmortality <- read_csv(\"posts/global-mortality-analysis/data/share-of-deaths-by-cause.csv\")\n\nmortality %>% \n  head() %>% \n  knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nEntity\nCode\nYear\nDeaths - Cardiovascular diseases - Sex: Both - Age: All Ages (Percent)\nDeaths - Neoplasms - Sex: Both - Age: All Ages (Percent)\nDeaths - Drowning - Sex: Both - Age: All Ages (Percent)\nDeaths - Maternal disorders - Sex: Both - Age: All Ages (Percent)\nDeaths - Chronic respiratory diseases - Sex: Both - Age: All Ages (Percent)\nDeaths - Alcohol use disorders - Sex: Both - Age: All Ages (Percent)\nDeaths - Drug use disorders - Sex: Both - Age: All Ages (Percent)\nDeaths - Fire, heat, and hot substances - Sex: Both - Age: All Ages (Percent)\nDeaths - Environmental heat and cold exposure - Sex: Both - Age: All Ages (Percent)\nDeaths - Exposure to forces of nature - Sex: Both - Age: All Ages (Percent)\nConflict (percent)\nTerrorism (percent)\nDeaths - Digestive diseases - Sex: Both - Age: All Ages (Percent)\nDeaths - Diabetes mellitus - Sex: Both - Age: All Ages (Percent)\nDeaths - Lower respiratory infections - Sex: Both - Age: All Ages (Percent)\nDeaths - Neonatal disorders - Sex: Both - Age: All Ages (Percent)\nDeaths - Diarrheal diseases - Sex: Both - Age: All Ages (Percent)\nDeaths - Road injuries - Sex: Both - Age: All Ages (Percent)\nDeaths - Cirrhosis and other chronic liver diseases - Sex: Both - Age: All Ages (Percent)\nDeaths - Tuberculosis - Sex: Both - Age: All Ages (Percent)\nDeaths - Chronic kidney disease - Sex: Both - Age: All Ages (Percent)\nDeaths - Alzheimer’s disease and other dementias - Sex: Both - Age: All Ages (Percent)\nDeaths - Parkinson’s disease - Sex: Both - Age: All Ages (Percent)\nDeaths - HIV/AIDS - Sex: Both - Age: All Ages (Percent)\nDeaths - Acute hepatitis - Sex: Both - Age: All Ages (Percent)\nDeaths - Self-harm - Sex: Both - Age: All Ages (Percent)\nDeaths - Malaria - Sex: Both - Age: All Ages (Percent)\nDeaths - Interpersonal violence - Sex: Both - Age: All Ages (Percent)\nDeaths - Nutritional deficiencies - Sex: Both - Age: All Ages (Percent)\nDeaths - Meningitis - Sex: Both - Age: All Ages (Percent)\nDeaths - Protein-energy malnutrition - Sex: Both - Age: All Ages (Percent)\nDeaths - Enteric infections - Sex: Both - Age: All Ages (Percent)\n\n\n\n\nAfghanistan\nAFG\n1990\n24.63\n6.35\n0.75\n1.45\n3.26\n0.04\n0.05\n0.18\n0.10\n0.00\n0.932\n0.0061204\n2.75\n1.16\n13.05\n8.57\n2.33\n2.28\n1.47\n2.56\n2.04\n0.61\n0.20\n0.02\n1.64\n0.38\n0.05\n0.84\n1.15\n1.19\n1.13\n2.54\n\n\nAfghanistan\nAFG\n1991\n23.58\n6.11\n0.72\n1.49\n3.14\n0.04\n0.05\n0.17\n0.06\n0.70\n2.044\n0.0340225\n2.65\n1.10\n12.73\n8.89\n2.56\n2.32\n1.41\n2.46\n1.93\n0.59\n0.19\n0.02\n1.60\n0.39\n0.10\n1.04\n1.12\n1.15\n1.10\n2.78\n\n\nAfghanistan\nAFG\n1992\n22.33\n5.86\n0.73\n1.59\n2.99\n0.04\n0.06\n0.17\n0.02\n0.30\n2.408\n0.0234631\n2.56\n1.03\n13.18\n9.63\n2.95\n2.45\n1.36\n2.39\n1.81\n0.56\n0.18\n0.02\n1.60\n0.41\n0.12\n1.10\n1.17\n1.19\n1.16\n3.17\n\n\nAfghanistan\nAFG\n1993\n21.27\n5.60\n0.75\n1.63\n2.86\n0.04\n0.06\n0.18\n0.02\n0.10\nNA\nNA\n2.47\n0.97\n13.84\n9.92\n3.64\n2.52\n1.31\n2.33\n1.71\n0.53\n0.17\n0.02\n1.60\n0.42\n0.05\n1.15\n1.26\n1.25\n1.24\n3.87\n\n\nAfghanistan\nAFG\n1994\n20.37\n5.34\n0.75\n1.59\n2.75\n0.04\n0.06\n0.17\n0.02\n0.07\n4.296\n0.0084545\n2.37\n0.92\n13.83\n9.64\n3.40\n2.48\n1.25\n2.26\n1.63\n0.50\n0.16\n0.03\n1.58\n0.41\n0.09\n1.18\n1.28\n1.25\n1.26\n3.62\n\n\nAfghanistan\nAFG\n1995\n20.32\n5.31\n0.77\n1.63\n2.76\n0.04\n0.06\n0.18\n0.02\n0.16\n2.557\n0.0018805\n2.37\n0.91\n13.82\n9.62\n3.89\n2.52\n1.25\n2.28\n1.61\n0.50\n0.16\n0.03\n1.60\n0.42\n0.07\n1.20\n1.27\n1.26\n1.25\n4.11\n\n\n\n\n\n\n\n\nThe dataset is in a wide format. It has 35 columns that include Entity (country), Code (country code), Year and then all the death causes by percentage of the total deaths for that country and year. For the analysis, the data is preferred in a long format (also called tidy format), so I will begin by converting the data to a long format and divide it between countries and regions, since the dataset also contains aggregated data by region.\nAnother thing I will do in this data cleaning step is replace some death causes for a more descriptive and short name, this is done with the death_causes_map vector, which maps the new names (on the left side) with the old ones (on the right side).\n\ndeath_causes_map <- c(\n  \"Cancers\" = \"Neoplasms\",\n  \"Suicide\" = \"Self-harm\",\n  \"Homicide\" = \"Interpersonal violence\",\n  \"Diabetes\" = \"Diabetes mellitus\",\n  \"Road incidents\" = \"Road injuries\",\n  \"Alzheimer's disease\" = \"Alzheimer's disease and other dementias\",\n  \"Drugs disorders\" = \"Drug use disorders\",\n  \"Liver diseases\" = \"Cirrhosis and other chronic liver diseases\",\n  \"Kidney diseases\" = \"Chronic kidney disease\",\n  \"Alcohol disorders\" = \"Alcohol use disorders\",\n  \"Fire\" = \"Fire, heat, and hot substances\",\n  \"Heat and cold exposure\" = \"Environmental heat and cold exposure\"\n)\n\nincome_categories <-\n  c(\"Low Income\",\n    \"Lower Middle Income\",\n    \"Upper Middle Income\",\n    \"High Income\")\n\nmortality_long <-\n  mortality %>%\n  pivot_longer(cols = contains(\"Percent\"),\n               names_to = \"death_cause\",\n               values_to = \"percent_affected\") %>%\n  mutate(death_cause = str_split(death_cause, \" - \")) %>%\n  unnest(death_cause) %>%\n  filter(!str_detect(death_cause, \"Deaths|Sex|Age\")) %>% \n  mutate(\n    death_cause = str_remove(death_cause, \" \\\\(.*\"),\n    percent_affected = percent_affected / 100,\n    death_cause = fct_recode(death_cause, !!!death_causes_map)\n  ) %>% \n  janitor::clean_names() %>%\n  filter(!is.na(percent_affected))\n\nmortality_by_country <-\n  mortality_long %>%\n  filter(!is.na(code),\n         entity != \"World\") %>%\n  rename(c(\"country\" = \"entity\", country_code = \"code\"))\n\nmortality_by_region <-\n  mortality_long %>%\n  filter(is.na(code) | code == \"OWID_WRL\") %>%\n  select(region = entity, code, year, death_cause, percent_affected) %>% \n  mutate(region = str_remove(region, \"World Bank \"),\n         region = fct_relevel(region, income_categories))\n\nmortality <- mortality %>%\n  janitor::clean_names()\n\nrm(mortality_long)\n\n\n\n\nDeath causes proportions presumably have different distribution around the world. First, I want to get an overall view of the global proportions. This is why I will begin the analysis with the dataset of death causes aggregated by regions. Here is a sample of the data\n\nmortality_by_region %>% \n  slice_sample(n = 10) %>% \n  knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\nregion\ncode\nyear\ndeath_cause\npercent_affected\n\n\n\n\nNorth America (WB)\nNA\n2006\nHeat and cold exposure\n0.0006\n\n\nEurope & Central Asia (WB)\nNA\n2008\nChronic respiratory diseases\n0.0384\n\n\nAfrican Region (WHO)\nNA\n2007\nLower respiratory infections\n0.0905\n\n\nSub-Saharan Africa (WB)\nNA\n1995\nHeat and cold exposure\n0.0006\n\n\nLow Income\nNA\n1993\nLower respiratory infections\n0.1086\n\n\nWestern Pacific Region (WHO)\nNA\n1995\nEnteric infections\n0.0101\n\n\nEast Asia & Pacific (WB)\nNA\n2010\nKidney diseases\n0.0215\n\n\nUpper Middle Income\nNA\n2003\nDiarrheal diseases\n0.0054\n\n\nSub-Saharan Africa (WB)\nNA\n2009\nNeonatal disorders\n0.0981\n\n\nEastern Mediterranean Region (WHO)\nNA\n2008\nMaternal disorders\n0.0093\n\n\n\n\n\n\nThis first plot shows the 20 more common global death causes in 2019\n\nmortality_by_region %>% \n  filter(code == \"OWID_WRL\",\n         year ==  2019) %>% \n  slice_max(percent_affected, n = 20) %>% \n  mutate(death_cause = fct_reorder(death_cause, percent_affected)) %>% \n  ggplot(aes(percent_affected, death_cause)) +\n  geom_col() +\n  scale_x_continuous(labels = scales::percent_format(),\n                     expand = c(0,0),\n                     limits = c(0,0.35)) +\n  labs(\n    title = \"What are the main global death causes in 2019?\",\n    y = NULL,\n    x = \"% of deaths associated to this cause\"\n  ) +\n  theme(axis.text.x = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.title.position = \"plot\",\n        panel.grid.major.y = element_blank())\n\n\n\n\n\n\n\n\nFrom this first plot we can already draw some interesting conclusions:\n\nAlmost \\(\\frac{1}{3}\\) of the global deaths are produced by Cardiovascular diseases (these include hypertension ; coronary heart disease ; cerebrovascular disease ; heart failure; and other heart diseases)\nThe second most common death cause with 18% of the total is Cancer (this category include all sort of cancers).\nThe most common death causes are all noncommunicable diseases, which are responsible for 74% of all deaths worldwide.\nYou are more likely to be killed by yourself (Suicide) that by someone else (Homicide).\n\nIn the dataset we also have death causes aggregated by the world bank income categories, which are:\n\nLow income countries\nLower middle income countries\nUpper middle income countries\nHigh income countries\n\nA first hypothesis might be that people of different incomes die of different causes, let’s use this data to explore this possibility\n\nmortality_by_region %>% \n  filter(str_detect(region, \"Income\"),\n         year == max(year)) %>%\n  filter(fct_lump(death_cause, 12, w = percent_affected) != \"Other\") %>%\n  mutate(death_cause = fct_reorder(death_cause, percent_affected, sum)) %>%\n  ggplot(aes(percent_affected, death_cause, fill = death_cause)) +\n  geom_col(show.legend = FALSE) +\n  facet_wrap(~ region, scales = \"free_y\") +\n  MetBrewer::scale_fill_met_d(\"Renoir\") +\n  scale_x_continuous(labels = scales::percent_format()) +\n  labs(title = \"Main global death causes in 2019 by income category\",\n       y = NULL,\n       x = \"% of deaths associated to this cause\") +\n  theme(axis.text.x = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.title.position = \"plot\",\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.x = element_blank())\n\n\n\n\n\n\n\n\nThis second plot looks more interesting than the previous one, another way of visualizing this data could be faceting by disease and make a line plot with the income category in the x axis and the percent of deaths in the y axis:\n\nmortality_by_region %>%\n  filter(str_detect(region, \"Income\"),\n         year == max(year)) %>%\n  arrange(region) %>%\n  mutate(region = str_wrap(region, 6),\n         region = fct_inorder(region)) %>%\n  filter(fct_lump(death_cause, 12, w = percent_affected) != \"Other\") %>%\n  mutate(death_cause = fct_reorder(death_cause, percent_affected, sum, .desc = TRUE)) %>%\n  ggplot(aes(region, percent_affected, group = death_cause)) +\n  geom_line() +\n  geom_point() +\n  scale_y_continuous(labels = scales::percent_format()) +\n  facet_wrap( ~ death_cause, scales = \"free_y\") +\n  expand_limits(y = 0) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  labs(\n    title = \"Main global death causes in 2019 by death cause\",\n    subtitle = \"Only considering the 12 most common death causes sorted in descending order\",\n    y = \"% of deaths associated to this cause\",\n    x = NULL\n  ) +\n  theme(axis.text.y = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.title.position = \"plot\",\n        panel.grid.minor.y = element_blank(),\n        strip.text = element_text(size = 10))\n\n\n\n\n\n\n\n\nI added a geom_smooth, which helps us fitting a trend line over the data. In this case, with the argument method = \"lm\" it fits a linear regression, which is why we see a straight blue line.\nFrom these two plots, we can extract valuable insights:\n\nThe percent of deaths related with cardiovascular diseases, cancers and alzheimer’s disease increase with the country’s income.\nNeonatal disorders, enteric infections and diarrheal diseases related deaths decrease (and are practically null) in countries with higher income.\nAround 5% of people in low income countries die of tuberculosis, even though the BCG vaccine to protect against this disease was introduce in 1921! Probably this topic requires some deeper analysis to understand if the vaccine is being administered in these countries or not.\nDiabetes, liver and digestive diseases affect in similar proportions at all the categories.\nRespiratory diseases show weak trends, looks like Chronic respiratory diseases increase with the income category while the lower respiratory infections decrease.\n\nSeems like there is a correlation between income and death causes. So far we’ve been working with aggregated data by income category, these income categories are based on the gross national income (GNI) of the country, as explained in this artice.\nWe could perform a more thorough analysis If we’d have access to the countries GNI. Using the {WDI} package, we can download the gross domestic product (GDP) per capita (correlated with GNI) for each country in the period of analysis (1990 - 2019)\n\nlibrary(WDI)\n\n# These are the indicators that will be downloaded with the WDI package\nindicators <- c(\n  \"gdp_pcap\" = \"NY.GDP.PCAP.CD\"\n)\n\nwdi_data_raw <-\n  WDI(\n    indicator = indicators,\n    start = 1990,\n    end = 2019,\n    extra = TRUE\n  ) %>%\n  as_tibble() %>%\n  arrange(country, year)\n\nwdi_data <- wdi_data_raw %>%\n  mutate(income = str_to_title(income),\n         income = fct_relevel(income, income_categories)) %>%\n  group_by(country) %>%\n  fill(gdp_pcap, .direction = \"downup\") %>%\n  ungroup()\n\nmortality_by_country_wdi <-\n  mortality_by_country %>%\n  left_join(wdi_data %>% select(-country),\n            by = c(\"country_code\" = \"iso3c\", \"year\"))\n\nmortality_by_country_wdi %>% \n  filter(year == 2019) %>% \n  head() %>% \n  knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ncountry\ncountry_code\nyear\ndeath_cause\npercent_affected\niso2c\ngdp_pcap\nstatus\nlastupdated\nregion\ncapital\nlongitude\nlatitude\nincome\nlending\n\n\n\n\nAfghanistan\nAFG\n2019\nCardiovascular diseases\n0.2462\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\nAfghanistan\nAFG\n2019\nCancers\n0.0843\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\nAfghanistan\nAFG\n2019\nDrowning\n0.0067\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\nAfghanistan\nAFG\n2019\nMaternal disorders\n0.0160\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\nAfghanistan\nAFG\n2019\nChronic respiratory diseases\n0.0281\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\nAfghanistan\nAFG\n2019\nAlcohol disorders\n0.0006\nAF\n494.1793\n\n2022-09-16\nSouth Asia\nKabul\n69.1761\n34.5228\nLow Income\nIDA\n\n\n\n\n\n\n\n\nNow that we have data on the GDP per capita for each country, we can build a model to predict the percent_affected using gdp_pcap as the predictor.\nNotice that we have different death causes. In this case, I would like to get a coefficient that explains \\[\\%affected \\sim GDPpercapita\\] for each death cause, that’s why I will fit one model per death cause.\nThis is easy to do with the {purrr} package, which let us implement functional programming concepts within the tidyverse. To read more about this topic, here are the vignettes of the package. Also, in the R for Data Science book you can find a chapter dedicated to fitting many models explaining these concepts.\nBefore creating our models, I will check the distribution of our predictor\n\nmortality_by_country_wdi %>% \n  filter(death_cause == \"Cardiovascular diseases\") %>% \n  ggplot(aes(gdp_pcap)) +\n  geom_histogram() +\n  scale_x_log10(labels = scales::dollar_format()) +\n  labs(x = \"GDP per capita in current US$ (log-scale)\",\n       title = \"Distribution of GDP per capita\") +\n  theme(axis.text = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.title.position = \"plot\",\n        panel.grid.minor.y = element_blank())\n\n\n\n\n\n\n\n\nNotice that GDP per capita has an approximate log-normal distribution, so I will apply a transformation (log2) to the predictor before fitting the model\nWhat about the response variable?\n\nmortality_by_country_wdi %>%\n  filter(year == max(year),\n         fct_lump(death_cause, 12, w = percent_affected) != \"Other\") %>%\n  ggplot(aes(percent_affected)) +\n  geom_histogram() +\n  facet_wrap(~ death_cause, scales = \"free\") +\n  scale_x_log10(labels = scales::percent_format()) +\n  labs(x = \"% of deaths (log-scale)\",\n       title = \"Distribution of % of deaths by cause\") +\n  theme(axis.text = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.title.position = \"plot\",\n        panel.grid.minor.y = element_blank())\n\n\n\n\n\n\n\n\nThe response variable also look log-normal distributed.\nIf we want to create linear models to predict: \\[log(\\% affected) \\sim \\beta_0 + \\beta_1log(GDPpercapita) + \\epsilon\\] It can be done with the lm() function. The problem with having both variables (dependent and independent) transformed by the log function is that it would be harder to interpret the coefficients (\\(\\beta_1\\)) of the model. That’s why I will start by fitting a simpler model of the form: \\[\\% affected \\sim \\beta_0 + \\beta_1log(GDPpercapita) + \\epsilon\\] In this case, our dependent variable is a percentage, that means that it can take values in the range \\([0, 1]\\). For this reason, a beta regression could be a good alternative to the linear regression. The advantage of the beta regression is that the output will always be in the mentioned range. The disadvantage is that it applies a transformation to the output (the logit function), and again, as with the log transformation, it would be harder to interpret the coefficients of the model. So, let’s fit some linear models and analyze their performance.\n\nmortality_model <-\n  mortality_by_country_wdi %>%\n  filter(year == max(year), \n         between(percent_affected, 0, 1),\n         gdp_pcap > 0) %>%\n  group_by(death_cause) %>%\n  nest() %>%\n  mutate(\n    model = map(data, ~ lm(percent_affected ~ log2(gdp_pcap), data = .)),\n    rsquared = map_dbl(model, ~ summary(.)$r.squared),\n    tidy_model = map(model, broom::tidy, conf.int = TRUE)\n  ) %>%\n  unnest(tidy_model) %>%\n  ungroup()\n\nmortality_model %>% \n  filter(term != \"(Intercept)\") %>% \n  mutate(death_cause = fct_reorder(death_cause, estimate)) %>% \n  ggplot(aes(estimate, death_cause)) +\n  geom_point() +\n  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.5) +\n  geom_vline(xintercept = 0, lty = 2) +\n  scale_x_continuous(labels = scales::percent_format()) +\n  labs(title = \"How does change in GDP affects death causes in 2019?\",\n       subtitle = \"Considering 199 countries. Error bars indicate 95% confidence interval\",\n       x = \"% change in death cause for each time GDP per capita doubles\",\n       y = \"Death cause\") +\n  theme(axis.text.x = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.subtitle = element_text(color = \"gray50\"),\n        plot.title.position = \"plot\",\n        panel.grid.minor.y = element_blank(),\n        strip.text = element_text(size = 10))\n\n\n\n\n\n\n\n\nThere is a lot of information in this plot:\n\nThe coefficients represent the change in the outcome for every time the GDP per capita doubles. For example: Cancers have a coefficient of 0.0361 (3.6%). Suppose we have a country with GDP per capita of US$ 10.000 and 10% of deaths are caused by cancer. If the GDP of the country doubles, going from US$ 10.000 to US$ 20.000, then the deaths caused by cancer are estimated to change from 10% to 13.6%\nThe error bars shows the 95% confidence intervals. This mean that for those death causes whose error bars overlap 0% we don’t have enough evidence (with a significance level \\(\\alpha\\) = 0.05) to say that change in GDP affects them. If we filter them out, we get this plot\n\n\nmortality_model %>% \n  filter(term != \"(Intercept)\",\n         p.value < 0.05) %>% \n  mutate(death_cause = fct_reorder(death_cause, estimate)) %>% \n  ggplot(aes(estimate, death_cause)) +\n  geom_point() +\n  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.5) +\n  geom_vline(xintercept = 0, lty = 2) +\n  scale_x_continuous(labels = scales::percent_format()) +\n  labs(title = \"How does change in GDP affects death causes in 2019?\",\n       subtitle = \"Considering 199 countries. Error bars indicate 95% confidence interval\",\n       x = \"% change in death cause for each time GDP per capita doubles\",\n       y = \"Death cause\") +\n  theme(axis.text.x = element_text(family = \"Tabular\"),\n        plot.title = element_text(size = 20),\n        plot.subtitle = element_text(color = \"gray50\"),\n        plot.title.position = \"plot\",\n        panel.grid.minor.y = element_blank(),\n        strip.text = element_text(size = 10))\n\n\n\n\n\n\n\n\nWhat does the relationship between GDP per capita and % of deaths looks like in a scatter plot?\n\nlibrary(glue)\nlibrary(ggtext)\n\nmortality_model %>%\n  filter(term != \"(Intercept)\",\n         p.value < 0.05) %>%\n  slice_max(abs(estimate), n = 12) %>% \n  mutate(augmented_model = map(model, broom::augment),\n    death_cause = str_replace(death_cause, \"-energy\", \"\"),\n    death_cause = glue(\"{death_cause} (*R*<sup>2</sup> = {round(rsquared, 2)})\"),\n    death_cause = fct_reorder(death_cause, estimate, first, .desc = TRUE)\n  ) %>%\n  unnest(augmented_model) %>% \n  mutate(gdp_pcap = 2^(`log2(gdp_pcap)`)) %>% \n  ggplot(aes(gdp_pcap, percent_affected)) +\n  geom_point(alpha = 0.5) +\n  geom_line(aes(y = .fitted), color = \"red\", alpha = 0.8, lty = 2, linewidth = 1.4) +\n  scale_x_log10(labels = scales::dollar_format()) +\n  scale_y_continuous(expand = c(0,0),\n                     labels = scales::percent_format(),\n                     limits = c(0, NA)) +\n  facet_wrap( ~ death_cause, scales = \"free_y\") +\n  theme_minimal(base_family = \"Roboto Condensed\", base_size = 12) +\n  labs(\n    title = \"How does GDP per capita correlates with different death causes by country in 2019?\",\n    subtitle = \"Only the 12 deaths causes that change the most with countries GDP's. y-axis scales are different for each plot. Sorted by descending slope\",\n    x = \"GDP per capita in current US$ (log-scale)\",\n    y = \"% of deaths for this cause\"\n  ) +\n  theme(\n    strip.text = element_markdown(face = \"bold\", size = 10),\n    plot.title.position = \"plot\",\n    plot.title = element_text(size = 20),\n    plot.subtitle = element_text(size = 10)\n  )\n\n\n\n\n\n\n\n\nIn this plot, the red dashed line represents the predictions of our linear model. Notice that the x axis is in log scale, and since we fit the model with a log scaled predictor, it makes sense that it predicts a straight line.\nLooks like this last plot confirms all our previous assumptions. Countries with higher incomes are more likely to have people dying of cancer, cardiovascular diseases and alzheimer’s disease, all these being noncommunicable diseases.\nOn the other hand, in countries with low income, you are more likely to die of tuberculosis, malaria, diarrheal diseases, enteric infections and neonatal disorders, all these are diseases that have treatment and in most cases could be avoided with a better hygiene and access to clean water, that’s why the probability of dying for this causes in higher income countries is almost zero.\nSo, the conclusion we drawn from the analysis is that money produces cancer? That doesn’t sound right… It’s important to highlight that age of death was never considered in this analysis, and a more reasonable hypothesis would be that people dying of cancer live longer than those dying of neonatal disorder. In this case, a more accurate conclusion might be: money allows you to live enough to die of cancer.\nNow we know what produced deaths around the world in 2019, another interesting question is: Have the death causes proportions been changing over the years within country? Is it more or less likely to die of communicable diseases nowadays than 30 years ago?\n\n\n\nIn this part of the analysis, I think the best way to visualize the data is with maps.\nAs a starting point, let’s plot the main death cause by country in 2019\n\nlibrary(rnaturalearth)\nlibrary(sf)\n\nworld <- ne_countries(scale = \"medium\", returnclass = \"sf\") %>%\n  filter(name != \"Antarctica\")\n\nmortality_by_country %>%\n  filter(year == 2019) %>%\n  group_by(country, year) %>%\n  slice_max(percent_affected, n = 1, with_ties = FALSE) %>%\n  ungroup() %>%\n  right_join(world, by = c(\"country_code\" = \"iso_a3\")) %>%\n  mutate(\n    death_cause = str_wrap(death_cause, 20),\n    death_cause = as.character(death_cause)\n  ) %>%\n  replace_na(list(death_cause = \"Unknown\")) %>% \n  mutate(death_cause = fct_reorder(death_cause, -percent_affected, sum)) %>% \n  ggplot() +\n  geom_sf(aes(fill = death_cause, geometry = geometry), size = 0.15) +\n  MetBrewer::scale_fill_met_d(\"Renoir\", direction = -1) +\n  ggthemes::theme_map(base_family = \"Roboto Condensed\") +\n  labs(title = \"Which is the main death cause per country in 2019?\",\n       fill = NULL) +\n  theme(\n    legend.position = \"bottom\",\n    legend.justification = \"bottom\",\n    plot.title = element_text(size = 20, face = \"bold\"),\n    legend.text = element_text(size = 10),\n    legend.key.width = unit(20, \"mm\"),\n    legend.key.height = unit(3, \"mm\")\n  ) +\n  guides(fill = guide_legend(label.position = \"bottom\",\n                             nrow = 1))\n\n\n\n\n\n\n\n\nCardiovascular diseases is the most common death cause in most countries, as we have already seen in the first plot of this post. Communicable diseases are the most common death cause in many African countries.\n\n\nIn this dataset we have 32 different death causes, though some are much common than others, that’s a lot of data to visualize. There is a great tool that can help us in this case: principal component analysis (PCA). From Wikipedia:\n\nPrincipal component analysis (PCA) is a popular technique for analyzing large datasets containing a high number of dimensions/features per observation, increasing the interpretability of data while preserving the maximum amount of information, and enabling the visualization of multidimensional data. Formally, PCA is a statistical technique for reducing the dimensionality of a dataset. This is accomplished by linearly transforming the data into a new coordinate system where (most of) the variation in the data can be described with fewer dimensions than the initial data. Many studies use the first two principal components in order to plot the data in two dimensions and to visually identify clusters of closely related data points.\n\nThe PCA could be done using the prcomp function from the {stats} package. Here is the implementation\n\nlibrary(countrycode)\n\nmortality_pca <-\n  mortality_by_country %>%\n  filter(year == max(year)) %>% \n  select(-year, -country) %>%\n  pivot_wider(names_from = death_cause, values_from = percent_affected) %>%\n  janitor::clean_names() %>%\n  column_to_rownames(\"country_code\") %>%\n  prcomp(scale. = TRUE)\n\nbroom::tidy(mortality_pca, \"d\") %>%\n  filter(cumulative < 0.9) %>%\n  ggplot(aes(x = PC)) +\n  geom_col(aes(y = percent)) +\n  geom_line(aes(y = cumulative)) +\n  geom_point(aes(y = cumulative)) +\n  scale_y_continuous(labels = scales::percent_format()) +\n  scale_x_continuous(\n    breaks = 1:13,\n    limits = c(0.5, 13.5),\n    expand = c(0, 0)\n  ) +\n  geom_text(aes(\n    y = percent,\n    label = scales::percent(percent, accuracy = .01)\n  ), nudge_y = 0.02, family = \"Tabular\") +\n  labs(title = \"What percentage of variation in the data is explained by each principal component?\",\n       y = NULL,\n       x = \"Principal component\",\n       subtitle = \"Only the first 13 components plotted, which account for 90% of the variance in the data\") +\n  theme(\n    axis.text = element_text(family = \"Tabular\"),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\",\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.x = element_blank()\n  )\n\n\n\n\n\n\n\n\nThe first 2 components almost explain 50% of the variance in the data, this means that we can replace the original 32 columns with only 2, and still explain 50% of the variability of the data. The advantage of having only 2 columns is that we can plot that in a scatter plot.\n\nbroom::tidy(mortality_pca) %>% \n  filter(PC < 3) %>% \n  pivot_wider(names_from = PC, values_from = value) %>% \n  set_names(c(\"country_code\", \"PC1\", \"PC2\")) %>% \n  mutate(continent = countrycode::countrycode(country_code, \"iso3c\", \"continent\"),\n         country = countrycode::countrycode(country_code, \"iso3c\", \"country.name\"),\n         country = str_remove_all(country, \"\\\\s\\\\(.*|\\\\s-.*\")) %>% \n  ggplot(aes(PC1, PC2)) +\n  geom_text(aes(label = country, color = continent), check_overlap = TRUE, key_glyph = \"point\") +\n  scale_color_brewer(palette = \"Set1\") +\n  labs(color = \"Continent\",\n       title = \"How are countries distributed in the plane of the first two principal components?\") +\n  theme(\n    axis.text = element_text(family = \"Tabular\"),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\")\n\n\n\n\n\n\n\n\nWe can see some geographical clustering here, looks like most of the African countries are on the left side, having a more negative PC1. On the right bottom corner we find most of the European countries, Singapore and Australia.\nWhat death causes contributes the most to the principal components?\n\nbroom::tidy(mortality_pca, \"rotation\") %>% \n  filter(PC <= 2) %>% \n  group_by(PC) %>% \n  slice_max(abs(value), n = 25) %>% \n  ungroup() %>% \n  mutate(column = str_to_sentence(str_replace_all(column, \"_\", \" \"))) %>%\n  mutate(column = tidytext::reorder_within(column, value, PC), \n         PC = paste(\"PC\",PC)) %>% \n  ggplot(aes(value, column)) +\n  geom_col() +\n  facet_wrap(~ PC, scales = \"free_y\", nrow = 1) +\n  tidytext::scale_y_reordered() +\n  labs(y = NULL, x = NULL) +\n  theme(\n    axis.text.x = element_text(family = \"Tabular\"),\n    panel.grid.major.y = element_blank())\n\n\n\n\n\n\n\n\nWe have seen some clusters in the principal component analysis, it makes sense to perform a cluster analysis to see what information can we extract.\n\n\n\nWhat is cluster analysis? From Wikipedia:\n\nCluster analysis or clustering is the task of grouping a set of objects in such a way that objects in the same group (called a cluster) are more similar (in some sense) to each other than to those in other groups (clusters). Cluster analysis itself is not one specific algorithm, but the general task to be solved. It can be achieved by various algorithms that differ significantly in their understanding of what constitutes a cluster and how to efficiently find them. Popular notions of clusters include groups with small distances between cluster members, dense areas of the data space, intervals or particular statistical distributions. Clustering can therefore be formulated as a multi-objective optimization problem.\n\nIn summary, clustering consists on finding groups in the data.\n\nmortality_kmeans <- \n  mortality_by_country %>%\n  filter(year == max(year)) %>% \n  select(-year, -country) %>%\n  pivot_wider(names_from = death_cause, values_from = percent_affected) %>%\n  janitor::clean_names() %>%\n  column_to_rownames(\"country_code\")\n\nmortality_scaled <- \n  mortality_kmeans %>% \n  scale()\n\nfactoextra::fviz_nbclust(mortality_scaled, kmeans, method = \"wss\") +\n  theme_minimal(base_family = \"Roboto Condensed\",\n                base_size = 13) +\n  theme(\n    axis.text = element_text(family = \"Tabular\"),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\"\n  )\n\n\n\n\n\n\n\n\nWith the help of the {factoextra} package we can easily plot total within sum of square vs the number of clusters. This help us to select the number of clusters (\\(k\\)) using the elbow method. In this case, a value of \\(k\\) in the range \\([2,4]\\) looks reasonable, I will choose \\(k = 3\\).\nNow we need to select which algorithm we want to use. I will use k-means algorithm, one of the simplest one.\n\nset.seed(2022)\n\nkm.res <- kmeans(mortality_scaled, 3, iter.max = 15, nstart = 10)\n\nfactoextra::fviz_cluster(km.res, mortality_kmeans) +\n  theme_minimal(base_family = \"Roboto Condensed\",\n                base_size = 13) +\n  MetBrewer::scale_color_met_d(\"Egypt\", direction = -1) +\n  MetBrewer::scale_fill_met_d(\"Egypt\", direction = -1) +\n  theme(\n    axis.text = element_text(family = \"Tabular\"),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\"\n  )\n\n\n\n\n\n\n\n\nThis is the same visualization we did before in the PCA analysis, but now the colors represent the clusters. What’s the location of the centers of the clusters?\n\nkm.res$centers %>% \n  as_tibble() %>% \n  rownames_to_column(\"cluster\") %>% \n  pivot_longer(-cluster) %>% \n  group_by(cluster) %>% \n  slice_max(abs(value), n = 15) %>% \n  ungroup() %>% \n  mutate(name = str_to_sentence(str_replace_all(name, \"_\", \" \"))) %>%\n  mutate(name = tidytext::reorder_within(name, value, cluster),\n         cluster = paste(\"Cluster\",cluster)) %>% \n  ggplot(aes(value, name)) +\n  geom_col() +\n  facet_wrap(~ cluster, scales = \"free_y\", nrow = 1) +\n  tidytext::scale_y_reordered() +\n  labs(title = \"Location of the centers of the clusters\",\n      y = NULL) +\n  theme(\n    axis.text.x = element_text(family = \"Tabular\"),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\",\n    strip.text = element_text(size = 12)\n  )\n\n\n\n\n\n\n\n\nFinally, let’s visualize the clusters in a world map\n\ncountry_cluster <- \n  tibble(\n    country_code = rownames(mortality_kmeans),\n    .cluster = factor(km.res$cluster)\n  )\n\nworld %>%\n  left_join(country_cluster, by = c(\"iso_a3\" = \"country_code\")) %>%\n  filter(!is.na(.cluster)) %>%\n  ggplot() +\n  geom_sf(aes(fill = .cluster), size = 0.15) +\n  ggthemes::theme_map(base_family = \"Roboto Condensed\") +\n  MetBrewer::scale_fill_met_d(\"Egypt\", direction = -1) +\n  labs(title = \"Countries clustered\",\n       fill = \"Cluster\") +\n  theme(\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\",\n    legend.text = element_text(size = 10),\n    legend.key.width = unit(4, \"mm\"),\n  )\n\n\n\n\n\n\n\n\nAll the African countries are either in cluster 2 or 3. Most of the European countries, the United States, Canada, China, Argentina and Australia are in cluster 1. This might indicate a correlation between cluster assignment and GDP per capita of the country. A good visualization in this case is a simple cross tabulation table, with counts of cluster and income category\n\nwdi_data %>%\n  filter(year == max(year)) %>%\n  inner_join(country_cluster, by = c(\"iso3c\" = \"country_code\")) %>%\n  filter(income != \"Not Classified\",\n         !is.na(income)) %>%\n  count(income, .cluster) %>%\n  mutate(income = str_to_title(income),\n         income = fct_relevel(income, income_categories)) %>%\n  ggplot(aes(.cluster, income, fill = n)) +\n  geom_tile(show.legend = FALSE) +\n  geom_text(aes(label = n), color = \"white\") +\n  MetBrewer::scale_fill_met_c(\"Demuth\", direction = -1) +\n  labs(title = \"How do Income categories relate with clusters?\",\n       x = \"Cluster #\",\n       y = NULL) +\n  theme(\n    panel.grid = element_blank(),\n    plot.title = element_text(size = 20),\n    plot.title.position = \"plot\"\n  )\n\n\n\n\n\n\n\n\nThis is interesting! The clusters model had no clue of the countries income during the fit, the only data it was trained on was the percent of deaths for each of the 32 causes in our dataset. Nevertheless, we find this great correlation between clusters and income categories, which ratify all the conclusions we have made so far in the analysis: GDP per capita is highly correlated with how people die.\nFor the next section I will add an income label to the clusters, I think it will make it easier to follow the analysis:\n\nCluster 1 ~ High Income\nCluster 2 ~ Middle Income\nCluster 3 ~ Low Income\n\nNow we are in conditions of trying to find an answer to the question we begin with: How does death causes have change over the years?\nThis is the process I will go through:\n\nTrain a classification model (XGBgboost) to predict the assigned cluster with the 2019 data, same data used to train the kmeans algorithm.\nUse the XGBoost model to predict the cluster for the previous years (1990 - 2018)\nVisualize how cluster assignment have change for each country over the years\n\nFor the XGBoost model I will use the {tidymodels} package, which facilitates the process of doing machine learning using tidyverse principles. It allows us to easily tune a model and evalate the results, here is the implementation:\n\nlibrary(tidymodels)\nlibrary(xgboost)\n\nmortality_wide <- \n  mortality_by_country %>% \n  pivot_wider(names_from = death_cause, values_from = percent_affected) %>% \n  janitor::clean_names() %>% \n  select(-conflict, -terrorism) # I leave out these death causes because there is almost no data for the majority of the countries\n\nmortality_cluster_2019 <- mortality_wide %>% \n  filter(year == max(year)) %>% \n  left_join(country_cluster, by = \"country_code\") %>% \n  mutate(.cluster = case_when(\n    .cluster == \"1\" ~ \"Cluster 1 ~ High Income\",\n    .cluster == \"2\" ~ \"Cluster 2 ~ Middle Income\",\n    .cluster == \"3\" ~ \"Cluster 3 ~ Low Income\",\n    TRUE ~ \"Other\"\n  ))\n\nclusters_levels <- c(\"Cluster 1 ~ High Income\", \"Cluster 2 ~ Middle Income\", \"Cluster 3 ~ Low Income\")\n\nmortality_folds <- \n  bootstraps(mortality_cluster_2019, times = 15)\n\nxgb_rec <- recipe(.cluster ~ ., data = mortality_cluster_2019) %>% \n  update_role(country, country_code, year, new_role = \"id\") %>% \n  step_normalize(all_numeric_predictors()) %>% \n  step_pca(all_numeric_predictors(), num_comp = tune())\n  \nxgb_spec <- boost_tree(\n  trees = tune(),\n  min_n = tune(),\n  mtry = tune(),\n  tree_depth = tune()\n) %>% \n  set_engine(\"xgboost\") %>% \n  set_mode(\"classification\")\n\nxgb_wf <- workflow(xgb_rec, xgb_spec)\n\ngrid <- grid_latin_hypercube(trees(),\n                     min_n(),\n                     tree_depth(),\n                     finalize(num_comp(), mortality_cluster_2019),\n                     finalize(mtry(), mortality_cluster_2019), \n                     size = 15) %>% \n  mutate(num_comp = pmin(num_comp, 30))\n\ndoParallel::registerDoParallel(cores = 2)\n\nxgb_rs <- tune_grid(\n  xgb_wf,\n  resamples = mortality_folds,\n  grid = grid,\n  control = control_grid(verbose = TRUE)\n)\n\nxgb_rs %>% \n  autoplot() + \n  theme_light() +\n  labs(title = \"Results of the model hyperparameter selection\") +\n  theme(plot.title.position = \"plot\",\n        plot.title = element_text(size = 15))\n\n\n\n\n\n\n\n\nThis plot shows the accuracy and ROC AUC metrics for the different hyperparameters we tune it on. We can see that in almost all cases the accuracy is higher than 90% and the ROC AUC score is around 98%, really good for a model. I don’t want to go deeper in hyperparameter tuning since it’s not the point of this post, I will just select the best model and continue.\n\nxgb_model <- xgb_wf %>% \n  finalize_workflow(xgb_rs %>% select_best(\"accuracy\")) %>% \n  fit(mortality_cluster_2019)\n\nmortality_wide_clusters <- augment(xgb_model, mortality_wide)\n\nmortality_wide_clusters %>% \n  select(country, year, .pred_class) %>% \n  slice_sample(n = 20) %>% \n  knitr::kable()\n\n\n\n\ncountry\nyear\n.pred_class\n\n\n\n\nSenegal\n2000\nCluster 3 ~ Low Income\n\n\nGuinea\n1995\nCluster 3 ~ Low Income\n\n\nUruguay\n2015\nCluster 1 ~ High Income\n\n\nGermany\n1991\nCluster 1 ~ High Income\n\n\nBenin\n2007\nCluster 3 ~ Low Income\n\n\nBelize\n2002\nCluster 2 ~ Middle Income\n\n\nGuatemala\n2012\nCluster 2 ~ Middle Income\n\n\nLebanon\n2019\nCluster 1 ~ High Income\n\n\nYemen\n1992\nCluster 3 ~ Low Income\n\n\nKyrgyzstan\n2003\nCluster 2 ~ Middle Income\n\n\nBenin\n2004\nCluster 3 ~ Low Income\n\n\nMoldova\n2011\nCluster 2 ~ Middle Income\n\n\nMicronesia (country)\n1997\nCluster 2 ~ Middle Income\n\n\nBahamas\n2003\nCluster 2 ~ Middle Income\n\n\nSpain\n2017\nCluster 1 ~ High Income\n\n\nIraq\n2001\nCluster 2 ~ Middle Income\n\n\nDominican Republic\n2014\nCluster 2 ~ Middle Income\n\n\nMadagascar\n2003\nCluster 3 ~ Low Income\n\n\nSamoa\n1992\nCluster 2 ~ Middle Income\n\n\nEswatini\n2013\nCluster 3 ~ Low Income\n\n\n\n\n\n\nThat’s what we wanted, a dataframe with the country, the year and the predicted cluster. Now we can make an animated visualization using the {gganimate} package\n\nclusters_animation <- world %>% \n  left_join(mortality_wide_clusters, by = c(\"iso_a3\" = \"country_code\")) %>%\n  filter(!is.na(.pred_class)) %>% \n  mutate(.pred_class = fct_relevel(.pred_class, !!!clusters_levels)) %>% \n  ggplot() +\n  geom_sf(aes(fill = .pred_class), size = 0.15) +\n  ggthemes::theme_map(base_family = \"Roboto Condensed\") +\n  MetBrewer::scale_fill_met_d(\"Egypt\", direction = -1) +\n  labs(title = \"Countries clustered in {current_frame}\",\n       fill = \"Cluster\") +\n  gganimate::transition_manual(year) +\n  theme(\n        plot.title = element_text(size = rel(2), face = \"bold\"),\n        legend.text = element_text(size = 10),\n        legend.key.width = unit(4,\"mm\"),\n  )\n\ngganimate::anim_save(\"posts/global-mortality-analysis/animation.gif\", clusters_animation, width = 1000, height = 500, fps = 6)\n\n\nMost of the countries have been moving from the low income level cluster to the high income level cluster, that’s great news! It means that even though nowadays we have a noticeable difference in causes of deaths around the world, the trend is positive. Neonatal disorders, meningitis, enteric infections, etc. are now less common than 30 years ago!\nThis is another visualization to show these change in clusters\n\nyears <- seq(1990, 2015, 5)\n\nmortality_wide_clusters %>% \n  filter(year %in% years) %>% \n  count(year, .pred_class) %>% \n  ggplot(aes(year, n, fill = .pred_class)) +\n  geom_col() +\n  scale_x_continuous(breaks = years) +\n  MetBrewer::scale_fill_met_d(\"Egypt\", direction = -1) +\n  labs(fill = \"Cluster:\",\n       y = \"Count\",\n       x = NULL) +\n  theme(\n    axis.text = element_text(family = \"Tabular\"),\n    panel.grid.minor.y = element_blank(),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank())\n\n\n\n\n\n\n\n\nSo, the trend is clear, communicable diseases are becoming a less frequent death cause over the time.\nThis is the end of this post, I hope you have found it helpful. I try to use different tools and methods through all the exploration. Although I didn’t explain the code, the idea of the post is that you can see the implementation of the tools in a context of an exploratory data analysis, copy the code that you find useful, and use it in your own analysis.\nAs a conclusion, the main insights extracted from the data are:\n\nCardiovascular diseases account for almost a third of the global deaths.\nNoncommunicable diseases account for 74% of the global deaths.\nPeople who live in countries with higher GDP per capita are more likely to die of Cardiovascular diseases, Cancers and alzheimer’s disease, and less likely to die of tuberculosis, malaria, enteric infections and many other communicable diseases.\nLastly, the most important, global trends are changing over time. Global health is getting better over the years, hopefully there will be a time when all the death causes that were eradicated in high income countries will also cease to exist in lower income countries."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Posts",
    "section": "",
    "text": "Data Analysis\n\n\nEDA\n\n\nMaps\n\n\nClusters\n\n\nPCA\n\n\n\n\nData Analysis of the death causes around the world, the data came from ‘our world in data’.\n\n\n\n\n\n\nNov 30, 2022\n\n\nMatias Taron Simoes\n\n\n\n\n\n\nNo matching items"
  }
]